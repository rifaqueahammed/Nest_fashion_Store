
<div class="container mt-5 mb-5 m-lg-5">
    <div class="row m-lg-5 justify-content-center">
        <div class="col-md-4 order-md-2 mb-4">
            <h5 class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-muted">Your cart has {{cart.numberOfItems.totalItems}} Items</span>
                <span class="badge badge-secondary badge-pill">3</span>
            </h5>
            <ul class="list-group mb-3">
                 {{#each cart.data}}
                <li class="list-group-item d-flex justify-content-between lh-condensed">
                     <div>
                    <img
                      src="/images/{{this.productDetails._id}}.jpg"
                      class="img-fluid rounded-3"
                      alt="Shopping item"
                      style="width: 20px; height: 20px;"
                    />
                     </div>
                    <div><p class="text-muted">{{this.productDetails.product_name}}</p></div>
                    <div><small class="text-muted">{{this.productQuantity}}</small></div>
                    <div> <h6 class="text-muted">₹ {{this.productPrice}}</h6></div>
                </li>
                 {{/each}}
                {{!-- <li class="list-group-item d-flex justify-content-between bg-light">
                    <div class="text-success">
                        <h6 class="my-0">Coupon code</h6>
                    </div>
                    <span class="text-success">-₹ 0</span>
                </li> --}}
                <li class="list-group-item d-flex justify-content-between">
                    <span>Total </span>
                    <strong id="total-amount">₹ {{cart.totalAmount.Amount}}</strong>
                </li>
            </ul>
            {{!-- <form class="card p-2">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Coupon code">
                    <div class="input-group-append">
                        <button type="submit" class="btn btn-secondary">Redeem</button>
                    </div>
                </div>
            </form> --}}
        </div>
        <div class="col-md-8 order-md-1">
            <h5 class="mb-3">Billing address</h5>
            <form class="" novalidate="" id="placeorder-form" >
                <div class="mb-3">
                    <label for="username">Name</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="name" name="name" placeholder="Name" required="">
                        <div class="invalid-feedback" style="width: 100%;"> Your username is required. </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="address1">Line 1</label>
                    <input type="text" class="form-control" id="address-line1" name="address1" placeholder="Housename" required="">
                    <div class="invalid-feedback"> Please enter your shipping address. </div>
                </div>
                <div class="mb-3">
                    <label for="address2">Line 2</label>
                    <input type="text" class="form-control" id="address-line2"  name="address2" placeholder="landmark area district  postoffice">
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="country">Country</label>
                        <select class="custom-select d-block w-100" id="country" name="country" required="">
                            <option value="">Choose...</option>
                            <option>India</option>
                        </select>
                        <div class="invalid-feedback"> Please select a valid country. </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="state">State</label>
                        <select class="custom-select d-block w-100" id="state" value="" name="state" required="">
                            <option value="">Choose...</option>
                            <option>Kerala</option>
                            <option>Karnataka</option>
                            <option>Tamilnadu</option>
                            <option>Telengna</option>
                        </select>
                        <div class="invalid-feedback"> Please provide a valid state. </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="pincode">Pincode</label>
                        <input type="text" class="form-control" id="pincode" name="pincode" placeholder="" required="">
                        <div class="invalid-feedback"> Pincode required. </div>
                    </div>
                </div>
                <hr class="mb-4">
                <div class="custom-control custom-checkbox" id="checkbox" onclick="permanentAddress()">
                    <input type="checkbox" class="custom-control-input" id="permanent-address" name="address" value="permanent-address">
                    <label class="custom-control-label" for="permanent-address">Billing address is the same as my permanent address</label>
                </div>
                <hr class="mb-4">
                <h4 class="mb-3">Payment</h4>
                <div class="d-block my-3">
                    <div class="custom-control custom-radio">
                        <input id="credit" name="paymentMethod" value="Cash On Delivery" type="radio" class="custom-control-input" checked="" required="">
                        <label class="custom-control-label" for="credit">Cash On Delivery</label>
                    </div>
                    <div class="custom-control custom-radio">
                        <input id="debit" name="paymentMethod" value="Online Payment" type="radio" class="custom-control-input" required="">
                        <label class="custom-control-label" for="debit">Online Payment</label>
                    </div>
                </div>
                <hr class="mb-4">
                <button class="btn btn-success btn-lg btn-block" type="submit">PLACE ORDER</button>
            </form>
        </div>
    </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script> 

$("#placeorder-form").submit((e) => { 
  const totalAmount = document.getElementById("total-amount").innerHTML;
  e.preventDefault(); 
  $.ajax({
    url:'/user/placeorder',
    method:'post', 
    data: $("#placeorder-form").serialize(),
    success: (response) => { 
      if(response.success){
         location.href = '/user/ordersuccess'
      }else{
        razorPayPayment(response);
      }
    }

  })
});

// online-payment

function razorPayPayment(order){
    var options = {
    "key": "rzp_test_67LSSBDdHnNhox", 
    "amount": order.amount, 
    "currency": "INR",
    "name": "Nest fashion",
    "description": "Test Transaction",
    "image": "https://example.com/your_logo",
    "order_id": order.id, 
    "handler": function (response){
        veryfyPayment(response,order);
    },
    "prefill": {
        "name": "Gaurav Kumar",
        "email": "gaurav.kumar@example.com",
        "contact": "9999999999"
    },
    "notes": {
        "address": "Razorpay Corporate Office"
    },
    "theme": {
        "color": "#3399cc"
    }
};

var rzp1 = new Razorpay(options);
rzp1.on('payment.failed', function (response){
         location.href = "/user/paymentFailed";
});
 rzp1.open();
    
}

function veryfyPayment(payment,order){
    $.ajax({
        url:'/user/verifyPayment',
        data:{
            payment,
            order
        },
        method:'post',
        success:(response) => {
            if(response.paymentSuccess){
                 location.href = '/user/ordersuccess'
            }
            else{
                 location.href = "/user/paymentFailed";
            }
        }
    })
}

// address

function permanentAddress(){
  $.ajax({
    url:'/user/permenanAddress',
    method:'get',
    success: (response) =>{
      if(response.status){
        document.getElementById('name').value = response.address.name;
        document.getElementById('address-line1').value = response.address.permanentAddress.housename;
        document.getElementById('address-line2').value = response.address.permanentAddress.area+","+response.address.permanentAddress.landmark+","+response.address.permanentAddress.district+","+response.address.permanentAddress.postoffice;
        document.getElementById('state').value = response.address.permanentAddress.state;
        document.getElementById('pincode').value = response.address.permanentAddress.pincode;
      }
      if(response.addressNotexist){
        Swal.fire({
          title: "You dont have permenant address",
          icon: "success",
          confirmButtonText: "OK",
        });
      }
    }
  })
}

</script>